<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3 Dolphins WhatsApp Monitor</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="./assets/favicon.png">
</head>

<body>
  <div class="wrap">
    <div class="header">
      <img class="logo" loading="lazy" src="./assets/logo.png" alt="3 Dolphins" />
      <h1>WhatsApp Monitoring</h1>
    </div>

    <div class="card row">
      <div class="col">
        <div>
          Status: <span id="status" class="chip chip--booting">booting</span>
        </div>
        <div>Me: <code id="me">-</code></div>
      </div>
      <div class="col right-col" style="max-width: 320px">
        <button id="logout" class="btn hidden">logout</button>
        <div id="qrbox" class="hidden"><span>QR muncul disini</span></div>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <h3>Messages by Client</h3>
        <div class="actions">
          <input id="search" type="search" class="search" placeholder="Search messages…" />
          <a id="exportAll" href="export.csv" class="btn-export btn-ghost btn-mini" download>Export CSV</a>
          <button id="clearAll" class="btn btn-ghost btn-mini hidden">Clear All</button>
        </div>
      </div>

      <div id="columns" class="cols"></div>
    </div>
  </div>

  <script>
    document.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;

      if ((isMac && e.metaKey && e.key === "f") ||
        (!isMac && e.ctrlKey && e.key === "f")) {
        e.preventDefault();

        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen();
        }
      }
    });
  </script>


  <script type="module">
    import { toCanvas } from "https://cdn.jsdelivr.net/npm/qrcode@1.5.4/+esm";

    const statusEl = document.getElementById("status");
    const meEl = document.getElementById("me");
    const qrBox = document.getElementById("qrbox");
    const messagesEl = document.getElementById("messages");

    const PRETTY = {
      booting: "booting",
      scan_qr: "scan QR",
      authenticated: "authenticated",
      ready: "ready",
      disconnected: "disconnected",
      auth_failure: "auth_failure",
    };
    const STATE_CLASS = {
      booting: "chip chip--booting",
      scan_qr: "chip chip--scan_qr",
      authenticated: "chip chip--authenticated",
      ready: "chip chip--ready",
      disconnected: "chip chip--disconnected",
      auth_failure: "chip chip--auth_failure",
    };
    const setStatus = (state) => {
      statusEl.className = STATE_CLASS[state] || "chip chip--booting";
      statusEl.textContent = PRETTY[state] || state;
    };

    const ws = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") +
      location.host +
      "/ws"
    );

    const renderQR = async (qr) => {
      showQR();
      qrBox.innerHTML = "";
      const canvas = document.createElement("canvas");
      await toCanvas(canvas, qr, { width: 300, margin: 1 });
      qrBox.appendChild(canvas);
    };

    ws.onmessage = async (ev) => {
      const { type, data } = JSON.parse(ev.data);

      if (type === "status") {
        setStatus(data.state);
        meEl.textContent = data.me || "-";
        updateLogoutButton(data.state);

        if (data.state === "scan_qr") {
          showQR();
          if (!qrBox.firstChild) qrBox.innerHTML = "<span>Loading QR…</span>";
          hideLogout();
        } else if (data.state === "ready" || data.state === "authenticated") {
          hideQR();
          showLogout();
        } else {
          hideQR();
          hideLogout();
        }
      }

      if (type === "qr") {
        await renderQR(data.qr);
        hideLogout();
      }

      if (type === "message") {
        const isInbound = data.direction !== "out";
        const unread = isInbound && !data.isRead;
        renderMsgIntoColumn(data, unread);
        applySearch(searchInput?.value || "");
        refreshClearAllVisibility();
      }


      if (type === "messages" && Array.isArray(data)) {
        data.forEach(m => {
          const unread = (m.direction !== "out") && !m.isRead;
          renderMsgIntoColumn(m, unread);
        });
        sortColumns();
        applySearch(searchInput?.value || "");
        refreshClearAllVisibility();
        columnsEl.querySelectorAll(".list").forEach(list => {
          updateEmptyState(list);
          updateUnreadUI(list);
        });
      }


      if (type === "cleared") {
        if (data.scope === "all") {
          colMap.clear();
          columnsEl.innerHTML = "";
          clearAllBtn && (clearAllBtn.disabled = false, clearAllBtn.textContent = "Clear All");
          searchInput && (searchInput.value = "");
          applySearch && applySearch("");
          refreshClearAllVisibility();
          return;
        }
        if (data.scope === "client") {
          removeColumnById(data.clientId);
          refreshClearAllVisibility();
          return;
        }
      }

      if (data.state === "booting" || data.state === "disconnected") {
        isLoggingOut = false;
      }

      if (type === 'marked' && data.scope === 'client') {
        const list = colMap.get(String(data.clientId));
        if (list) {
          list.querySelectorAll('.msg.msg--in.unread').forEach(el => el.classList.remove('unread'));
          updateUnreadUI(list);
        }
      }

    };

    const columnsEl = document.getElementById("columns");

    columnsEl.addEventListener("click", async (ev) => {
      // 1) MARK READ (per kolom)
      const markBtn = ev.target.closest(".mark-read");
      if (markBtn) {
        const clientId = markBtn.getAttribute("data-clientid");
        if (!clientId) return;

        const list = colMap.get(String(clientId));
        if (list) {
          list.querySelectorAll(".msg.msg--in.unread").forEach(el => el.classList.remove("unread"));
          updateUnreadUI(list);
        }

        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "cmd", data: { action: "mark_read_client", clientId } }));
        }
        return;
      }

      // 2) CLEAR COL
      const clearBtn = ev.target.closest(".clear-col");
      if (clearBtn) {
        const clientId = clearBtn.getAttribute("data-clientid");
        if (!clientId || ws.readyState !== WebSocket.OPEN) return;

        const list = colMap.get(String(clientId));
        if (!list) return;

        list.querySelectorAll(".msg.unread").forEach(el => el.classList.remove("unread"));
        updateUnreadUI(list);

        const card = clearBtn.closest(".colcard");
        const label = card?.querySelector("h4")?.textContent || clientId;

        const ok = await confirmModal({
          title: `Clear kolom "${label}"?`,
          message: `Semua pesan pada kolom ini akan dihapus.`,
          confirmText: "Ya, hapus kolom ini"
        });
        if (!ok) return;

        ws.send(JSON.stringify({ type: "cmd", data: { action: "clear_client", clientId } }));
        return;
      }
    });


    function removeColumnById(clientId) {
      const list = colMap.get(clientId);
      if (!list) return;
      const card = list.closest(".colcard");
      if (card) card.remove();
      colMap.delete(clientId);
      sortColumns();
    }

    const colMap = new Map();

    const esc = (s) => (s || "").replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));

    function ensureCol(clientId, label, phone) {
      const key = String(clientId);
      if (colMap.has(key)) return colMap.get(key);

      const card = document.createElement("div");
      card.className = "colcard";
      card.innerHTML = `
        <div class="col-head">
          <div class="col-title">
            <h4>${esc(label)}</h4>
            ${phone ? `<div class="subtitle"><code>${esc(phone)}</code></div>` : ""}
          </div>
          <div class="col-actions">
            <a class="btn btn-export btn-ghost btn-mini" href="export.csv?client=${encodeURIComponent(key)}" download>Export</a>
            <button class="btn btn-ghost btn-mini clear-col" data-clientid="${key}">Clear</button>
          </div>
        </div>
        <div class="list"></div>
        <div class="col-sticky hidden" data-clientid="${key}">
          <span class="stat"><span class="unread-count">0</span> pesan belum dibaca</span>
          <button class="btn btn-mini mark-read" data-clientid="${key}">Tandai dibaca</button>
        </div>
      `;

      card.dataset.colsearch = buildColIndex(label, phone, key);

      columnsEl.appendChild(card);

      const list = card.querySelector(".list");
      colMap.set(key, list);

      sortColumns();
      return list;
    }

    const exportAllBtn = document.getElementById("exportAll");

    function refreshClearAllVisibility() {
      const hasAnyMessage = !!columnsEl.querySelector('.list .msg');
      clearAllBtn?.classList.toggle('hidden', !hasAnyMessage);
      exportAllBtn?.classList.toggle('hidden', !hasAnyMessage);
    }

    const jidToPhone = (jid) => String(jid || "").replace(/@.+$/, "");
    const toLocalId = (num) =>
      num.startsWith("62") ? "0" + num.slice(2) : num;
    const digits = (s) => String(s || "").replace(/\D/g, "");

    const buildColIndex = (label, phone, key) => {
      const p = String(phone || '');
      return [norm(label), norm(p), String(key || '').toLowerCase(), digits(p)]
        .filter(Boolean)
        .join(' ');
    };

    const buildMsgIndex = (m) => {
      const parts = [
        m.body, m.name, m.clientLabel, m.clientPhone, m.clientId
      ].map(x => norm(x || ''));
      parts.push(digits(m.clientPhone || ''));
      return parts.join(' ');
    };


    function senderLabelHTML(m) {
      const raw = jidToPhone(m.from);
      const local = toLocalId(raw);
      const name = (m.name || "").trim();

      const phoneHTML = `<code>${esc(local)}</code>`;

      if (!name) return phoneHTML;

      const nameDigits = digits(name);
      const phoneDigits = digits(local);
      if (nameDigits && nameDigits === phoneDigits) return phoneHTML;

      return `${esc(name)} - [${phoneHTML}]`;
    }

    // ===== Render per kolom =====
    function setupClamp(container) {
      const body = container.querySelector(".body");
      const btn = container.querySelector(".readmore");
      requestAnimationFrame(() => {
        if (body && btn && body.scrollHeight > body.clientHeight + 2) {
          btn.classList.remove("hidden");
        }
      });
      btn?.addEventListener("click", () => {
        const expanded = body.classList.toggle("expanded");
        btn.textContent = expanded ? "Closed" : "Read More";
        btn.setAttribute("aria-expanded", String(expanded));
      });
    }

    function updateEmptyState(list) {
      const card = list.closest(".colcard");
      const empty = card?.querySelector(".empty");
      if (!empty) return;

      const total = list.querySelectorAll(".msg").length;
      if (total === 0) {
        empty.textContent = "No messages";
        empty.classList.add("show");
        return;
      }

      const hasVisible = Array.from(list.querySelectorAll(".msg"))
        .some(el => !el.classList.contains("hidden-search"));
      if (!hasVisible && currentQuery && !card.classList.contains("hidden-col")) {
        empty.textContent = "No results";
        empty.classList.add("show");
      } else {
        empty.classList.remove("show");
      }
    }

    function renderMsgIntoColumn(m, unread = true) {
      const list = ensureCol(m.clientId || m.clientLabel || "UNKNOWN", m.clientLabel || m.clientId, m.clientPhone || "");
      const d = new Date(m.ts);
      const dir = m.direction === "out" ? "out" : "in";

      const bodyHtml = esc(m.body || "").replace(/\n/g, "<br>");
      const senderLine = esc(m.name || "");

      const div = document.createElement("div");
      div.className = `msg msg--${dir}`;
      div.dataset.search = buildMsgIndex(m);

      div.innerHTML = `
        <div class="msg__bubble">
          <div class="msg__meta"><span class="ts">${d.toLocaleString("id-ID")}</span></div>
          <div class="sender">${senderLine}</div>
          <div class="body">${bodyHtml}</div>
          <button type="button" class="readmore hidden" aria-expanded="false">Baca lengkap</button>
        </div>
      `;

      if (unread && dir === "in") div.classList.add("unread");

      list.prepend(div);
      setupClamp(div);

      if (currentQuery) {
        const qDigits = digits(currentQuery);
        const s = div.dataset.search || '';
        const match = s.includes(currentQuery) || (qDigits && s.includes(qDigits));
        div.classList.toggle("hidden-search", !match);
      }

      updateEmptyState(list);
      updateUnreadUI(list);
    }



    const collator = new Intl.Collator("id-ID", { sensitivity: "base" });

    function sortColumns() {
      const cards = Array.from(columnsEl.children);
      cards.sort((a, b) => {
        const ta = (a.querySelector("h4")?.textContent || "").toUpperCase();
        const tb = (b.querySelector("h4")?.textContent || "").toUpperCase();
        return ta.localeCompare(tb, 'id-ID', { sensitivity: 'base' });
      });
      cards.forEach((el) => columnsEl.appendChild(el));
    }

    function orderForTag(tag) {
      if (tag === "UNASSIGNED") return 10_000;
      const m = /CLIENT\s+(\d+)/i.exec(tag);
      return m ? parseInt(m[1], 10) : 5_000;
    }

    const logoutBtn = document.getElementById("logout");
    const clearAllBtn = document.getElementById("clearAll");

    clearAllBtn?.addEventListener("click", async () => {
      if (ws.readyState !== WebSocket.OPEN) return;
      const ok = await confirmModal({
        title: "Clear semua pesan?",
        message: "Tindakan ini akan menghapus semua pesan dari semua kolom.",
        confirmText: "Ya, hapus semua"
      });
      if (!ok) return;

      clearAllBtn.disabled = true;
      clearAllBtn.textContent = "Clearing…";
      ws.send(JSON.stringify({ type: "cmd", data: { action: "clear_all" } }));
      setTimeout(() => {
        if (clearAllBtn.disabled) { clearAllBtn.disabled = false; clearAllBtn.textContent = "Clear All"; }
      }, 3000);
    });


    // ===== Confirm modal helpers =====
    const $modal = document.getElementById('confirmModal');
    const $mTitle = document.getElementById('confirmTitle');
    const $mMsg = document.getElementById('confirmMsg');
    const $mOk = document.getElementById('confirmOk');
    const $mCancel = document.getElementById('confirmCancel');

    function confirmModal({ title = 'Konfirmasi', message = 'Yakin?', confirmText = 'Ya' }) {
      $mTitle.textContent = title;
      $mMsg.textContent = message;
      $mOk.textContent = confirmText;
      $modal.classList.remove('hidden');

      return new Promise((resolve) => {
        const cleanup = () => {
          $modal.classList.add('hidden');
          $mOk.removeEventListener('click', onOk);
          $mCancel.removeEventListener('click', onCancel);
          $modal.removeEventListener('click', onBackdrop);
          document.removeEventListener('keydown', onEsc);
        };
        const onOk = () => { cleanup(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };
        const onBackdrop = (e) => { if (e.target === $modal) onCancel(); };
        const onEsc = (e) => { if (e.key === 'Escape') onCancel(); };

        $mOk.addEventListener('click', onOk);
        $mCancel.addEventListener('click', onCancel);
        $modal.addEventListener('click', onBackdrop);
        document.addEventListener('keydown', onEsc);
        $mOk.focus();
      });
    }

    function showLogout() {
      logoutBtn?.classList.remove("hidden");
    }
    function hideLogout() {
      logoutBtn?.classList.add("hidden");
    }

    const showQR = () => {
      qrBox.classList.remove("hidden");
      hideLogout();
    };
    const hideQR = () => {
      qrBox.classList.add("hidden");
      qrBox.innerHTML = "";
    };

    let isLoggingOut = false;

    logoutBtn?.addEventListener("click", handleLogout);
    async function handleLogout() {
      if (!logoutBtn) return;

      if (isLoggingOut) return;

      if (ws.readyState !== WebSocket.OPEN) {
        console.warn("[logout] WebSocket not OPEN, ignoring click.");
        return;
      }

      let ok = false;
      try {
        ok = await confirmModal({
          title: "Yakin ingin keluar?",
          message: "Tindakan ini akan menghilangkan koneksi WhatsApp.",
          confirmText: "Ya, Keluar"
        });
      } catch (e) {
        console.error("[logout] confirmModal error:", e);
        return;
      }
      if (!ok) return;

      isLoggingOut = true;
      const prevLabel = logoutBtn.textContent;
      logoutBtn.disabled = true;
      logoutBtn.textContent = "Logging out…";

      const SAFETY_MS = 8000;
      const safetyTimer = setTimeout(() => {
        if (!isLoggingOut) return;
        console.warn("[logout] safety timer fired, restoring button.");
        restoreLogoutButton(prevLabel);
      }, SAFETY_MS);

      try {
        ws.send(JSON.stringify({ type: "cmd", data: { action: "logout" } }));
      } catch (e) {
        clearTimeout(safetyTimer);
        console.error("[logout] ws.send failed:", e);
        restoreLogoutButton(prevLabel);
        return;
      }

    }

    function restoreLogoutButton(prevLabel) {
      isLoggingOut = false;
      if (!logoutBtn) return;
      logoutBtn.disabled = false;
      logoutBtn.textContent = prevLabel || "Logout";
    }


    function updateLogoutButton(state) {
      if (!logoutBtn) return;

      logoutBtn.disabled = state === "booting";
      logoutBtn.textContent = logoutBtn.disabled ? "Logging out…" : "Logout";
    }

    ws.addEventListener("open", () => updateLogoutButton("ready"));
    ws.addEventListener("close", () => updateLogoutButton("booting"));
    ws.addEventListener("error", () => updateLogoutButton("booting"));

    const searchInput = document.getElementById("search");

    const norm = (s) => String(s || "").toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g, "");
    let currentQuery = "";

    function findTagMatch(qNorm) {
      if (!qNorm) return null;
      for (const key of colMap.keys()) {
        if (norm(key) === qNorm) return key;
      }
      return null;
    }

    function applySearch(qStr) {
      currentQuery = norm(qStr.trim());
      const qDigits = digits(currentQuery);

      const cards = Array.from(columnsEl.querySelectorAll(".colcard"));
      for (const card of cards) {
        const list = card.querySelector(".list");
        const colIdx = (card.dataset.colsearch || '');
        const colMatch = currentQuery &&
          (colIdx.includes(currentQuery) || (qDigits && colIdx.includes(qDigits)));

        if (!currentQuery) {
          card.classList.remove("hidden-col");
          Array.from(list.children).forEach(el => el.classList.remove("hidden-search"));
          updateEmptyState(list);
          continue;
        }

        if (colMatch) {
          card.classList.remove("hidden-col");
          Array.from(list.children).forEach(el => el.classList.remove("hidden-search"));
          updateEmptyState(list);
          continue;
        }

        let visibleCount = 0;
        Array.from(list.children).forEach(el => {
          if (!el.classList.contains("msg")) return;
          const s = el.dataset.search || '';
          const match = s.includes(currentQuery) || (qDigits && s.includes(qDigits));
          el.classList.toggle("hidden-search", !match);
          if (match) visibleCount++;
        });

        card.classList.toggle("hidden-col", visibleCount === 0);
        updateEmptyState(list);
      }
    }

    function updateUnreadUI(listEl) {
      const card = listEl.closest(".colcard");
      if (!card) return;
      const sticky = card.querySelector(".col-sticky");
      const cnt = card.querySelector(".unread-count");
      if (!sticky || !cnt) return;

      const total = listEl.querySelectorAll(".msg").length;
      // hanya hitung inbound unread
      const n = listEl.querySelectorAll(".msg.msg--in.unread:not(.hidden-search)").length;

      cnt.textContent = String(n);
      sticky.classList.toggle("hidden", total === 0);

      const btn = sticky.querySelector(".mark-read");
      if (btn) btn.disabled = (n === 0);
    }

  </script>
  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal__backdrop"></div>
    <div class="modal__dialog">
      <h4 id="confirmTitle">Konfirmasi</h4>
      <p id="confirmMsg">Yakin?</p>
      <div class="modal__actions">
        <button id="confirmCancel" class="btn btn-ghost btn-mini">Batal</button>
        <button id="confirmOk" class="btn btn-danger btn-mini">Ya, hapus</button>
      </div>
    </div>
  </div>
</body>

</html>